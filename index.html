<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depth Nexus - Journal Miner & Conscious Engagement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Using a deep, purposeful blue/purple to signify 'Depth' */
            --depth-color: #7c3aed; /* violet-600 */
            --mint-ready: #10b981; /* emerald-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0c1e; /* Deep dark blue */
            color: #e5e7eb;
        }
        .miner-card {
            background-color: #1a1b32; /* Slightly lighter deep blue */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 4, 0, 0.2);
            border-top: 4px solid var(--depth-color);
        }
        .button-primary {
            transition: all 0.15s ease;
        }
        .button-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        .button-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .cooldown-text {
            min-height: 20px; /* Ensure space is reserved */
            font-size: 0.875rem;
            font-weight: 600;
        }
        /* Modal Styles */
        .modal {
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh; /* Limit modal height */
            background-color: #1a1b32;
        }
        .upgrade-purchased {
            background-color: #3f6212; /* Darker green */
            color: #d9f99d; /* Light green text */
            opacity: 0.7;
            cursor: default;
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- HARDCODED FIREBASE CONFIGURATION (Using user's provided details) ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyDSpnfJnbdl0cSt0_Aoxy3seEYUvqsvsuw",
            authDomain: "dnx-miner.firebaseapp.com",
            projectId: "dnx-miner",
            storageBucket: "dnx-miner.firebasestorage.app",
            messagingSenderId: "262576543527",
            appId: "1:262576543527:web:9ccb7b82f84e837e5c3b02",
            measurementId: "G-DN42XZC24V"
        };
        const appId = "dnx-miner"; // Project ID used as the app ID for firestore path
        // -----------------------------------------------------------------------

        // Global Firebase instances and state
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;

        // Ensure global access to game functions
        window.saveGameState = saveGameState;
        window.loadGameState = loadGameState;
        window.setupFirebase = setupFirebase;
        window.submitJournalEntry = submitJournalEntry;
        window.buyUpgrade = buyUpgrade;
        window.completeTask = completeTask;
        window.openLedgerModal = openLedgerModal; 
        window.closeLedgerModal = closeLedgerModal; 
        window.openTaskModal = openTaskModal; 
        window.closeTaskModal = closeTaskModal; 
        window.displayRandomPrompt = displayRandomPrompt; 
        window.displayInitialPrompt = displayInitialPrompt; 

        setLogLevel('Debug');

        async function setupFirebase() {
            if (!FIREBASE_CONFIG.projectId) {
                console.error("Firebase configuration is incomplete.");
                window.isAuthReady = true;
                return;
            }

            try {
                const app = initializeApp(FIREBASE_CONFIG);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // For a standalone app, we sign in anonymously since there is no custom token backend.
                await signInAnonymously(window.auth);

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Authenticated with user ID:", window.userId);
                    } else {
                        // This case should not happen after signInAnonymously unless sign-out is explicit
                        window.userId = null; 
                    }
                    window.isAuthReady = true;
                    // Only start loading game state once auth is confirmed
                    loadGameState(); 
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                window.isAuthReady = true;
                loadGameState();
            }
        }

        function getMinerDocRef() {
            if (!window.db || !window.userId) return null;
            // Uses the hardcoded 'appId' (which is 'dnx-miner')
            const path = `artifacts/${appId}/users/${window.userId}/depth_nexus_data`; 
            return doc(window.db, path, 'miner_state');
        }

        function getJournalCollectionRef() {
            if (!window.db || !window.userId) return null;
            // Uses the hardcoded 'appId'
            const path = `artifacts/${appId}/users/${window.userId}/journal_entries`;
            return collection(window.db, path);
        }

        async function saveGameState() {
            if (!window.isAuthReady || !window.db || !window.userId) return;

            const state = {
                dnxBalance: window.dnxBalance,
                tapReward: window.tapReward,
                lastTapTimestamp: window.lastTapTimestamp,
                taskCompleted: window.taskCompleted,
                upgrades: window.upgrades, 
                initialPromptIndex: window.initialPromptIndex, 
                lastSave: Date.now(),
            };
            try {
                await setDoc(getMinerDocRef(), state, { merge: true });
                console.log("Miner state saved.");
            } catch (e) {
                console.error("Error saving miner state: ", e);
            }
        }

        async function saveJournalEntry(text, wasMinted, reward, promptText) {
            const collectionRef = getJournalCollectionRef();
            if (!collectionRef) {
                console.error("Cannot save journal: Firebase not ready.");
                return;
            }
            try {
                await addDoc(collectionRef, {
                    timestamp: Date.now(),
                    text: text,
                    wasMinted: wasMinted,
                    dnxReward: reward,
                    prompt: promptText,
                    userId: window.userId
                });
                console.log("Journal entry saved to Firestore (Collection).");
            } catch (e) {
                console.error("Error saving journal entry: ", e);
            }
        }
        
        async function fetchJournalEntries() {
            const collectionRef = getJournalCollectionRef();
            if (!collectionRef) {
                console.error("Journal collection not available. Auth or DB not ready.");
                return [];
            }

            try {
                const q = query(collectionRef, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                const entries = [];
                querySnapshot.forEach((doc) => {
                    entries.push({ id: doc.id, ...doc.data() });
                });
                return entries;

            } catch (e) {
                console.error("Error fetching journal entries:", e);
                return [];
            }
        }

        function loadGameState() {
            if (!window.isAuthReady || !window.db || !window.userId) {
                console.log("Using default in-memory state. Firebase connection likely failed or is loading.");
                document.getElementById('user-id').textContent = 'Loading...';
                updateUI();
                window.displayInitialPrompt(true);
                return;
            }

            const docRef = getMinerDocRef();
            onSnapshot(docRef, (docSnap) => { 
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.dnxBalance = data.dnxBalance || 0.0;
                    window.tapReward = data.tapReward || 0.05;
                    window.lastTapTimestamp = data.lastTapTimestamp || 0;
                    window.taskCompleted = data.taskCompleted || { 1: false, 2: false };
                    
                    // Load new upgrade status (nested object with defaults)
                    window.upgrades = data.upgrades || { 
                        cepTier: 0, 
                        clarityPurchased: false 
                    }; 

                    window.initialPromptIndex = data.initialPromptIndex !== undefined ? data.initialPromptIndex : Math.floor(Math.random() * JOURNAL_PROMPTS.length);
                    
                    console.log("Game state loaded successfully.");
                } else {
                    console.log("No data found, using defaults and saving initial state.");
                    // Initialize prompt index if no data exists
                    window.initialPromptIndex = Math.floor(Math.random() * JOURNAL_PROMPTS.length);
                    window.upgrades = { 
                        cepTier: 0, 
                        clarityPurchased: false 
                    }; 
                    saveGameState();
                }
                // Update the prompt based on loaded index
                window.displayInitialPrompt(false); 
                updateUI();
            }, (error) => {
                console.error("Error listening to document:", error);
                updateUI();
                window.displayInitialPrompt(true);
            });

            document.getElementById('user-id').textContent = window.userId;
        }

    </script>

</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="game-container" class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white">
                <span style="color:var(--depth-color);">$DEPTH</span> Ecosystem: Depth Nexus
            </h1>
            <p class="text-sm mt-2 text-gray-400">
                Incentivizing Consciousness: **Journal to Mine** $DNX$ once every 24 hours.
            </p>
            <p id="user-info" class="text-sm mt-2 text-gray-600">
                User ID: <span id="user-id" class="text-xs text-gray-700">Loading...</span>
            </p>
        </header>

        <!-- Main Stats & Balance -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="miner-card p-4 rounded-xl">
                <p class="text-sm font-medium text-gray-400">Your $DNX$ Balance</p>
                <p id="dnx-balance" class="text-3xl font-bold text-white mt-1">0.0000</p>
            </div>
            <div class="miner-card p-4 rounded-xl">
                <p class="text-sm font-medium text-gray-400">Reward Per Mint (Base)</p>
                <p id="tap-reward" class="text-3xl font-bold text-white mt-1">0.0500</p>
            </div>
            <div class="miner-card p-4 rounded-xl">
                <p class="text-sm font-medium text-gray-400">Next $DNX$ Mint in</p>
                <p id="mint-remaining" class="text-xl sm:text-3xl font-bold text-green-400 mt-1">0h 0m 0s</p>
            </div>
        </div>

        <!-- Ecosystem Synergy Tasks (MOVED TO TOP) -->
        <div class="miner-card p-6 rounded-xl mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-white">Ecosystem Synergy Tasks (First Steps)</h2>
            <p class="text-sm text-gray-400 mb-4">Complete these one-time onboarding tasks to **Acquire Initial Capital** and cement your connection to the core network.</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="task-list">
                <!-- Task 1: Wallet Sign-Up (Now Opens Modal) -->
                <div class="bg-gray-800 p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-white">Initiate: The Depth Operating System</p>
                        <p class="text-xs text-gray-400">Secure your entry point to the conscious economy.</p>
                    </div>
                    <button id="task-1" onclick="openTaskModal(1)"
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold button-primary hover:bg-purple-700">
                        Earn 0.1 $DNX$
                    </button>
                </div>
                <!-- Task 2: KYC/Verification (Now Opens Modal) -->
                <div class="bg-gray-800 p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-white">Verify: The Digital Integrity Protocol</p>
                        <p class="text-xs text-gray-400">Align your identity with the $DEPTH$ platform.</p>
                    </div>
                    <button id="task-2" onclick="openTaskModal(2)"
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold button-primary hover:bg-purple-700">
                        Earn 0.2 $DNX$
                    </button>
                </div>
            </div>
        </div>

        <!-- Mining and Educational Claim Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 1. Journal Entry Area -->
            <div class="miner-card p-6 rounded-xl lg:col-span-1">
                <h2 class="text-2xl font-semibold mb-4 text-white">Daily Conscious Journal</h2>
                <p class="text-sm text-gray-400 mb-4">
                    Plant your daily seed of self-awareness. Submission requires a minimum of 
                    <strong id="min-chars">50 characters</strong>.
                </p>
                
                <div id="mining-status" class="cooldown-text text-center py-2 mb-4 text-yellow-300 rounded-lg">Checking Mint Eligibility...</div>
                
                <!-- Prompt and Refresh Button -->
                <div class="flex justify-between items-center mb-2">
                    <p class="text-white font-medium text-sm">Today's Prompt:</p>
                    <button id="refresh-button" onclick="displayRandomPrompt(true)" class="text-xs text-violet-400 hover:text-violet-300 font-bold border border-violet-400 px-2 py-1 rounded-full transition duration-150">
                        Refresh
                    </button>
                </div>
                <p id="current-journal-prompt" class="text-violet-400 italic mb-4 text-base">Loading prompt...</p>
                
                <!-- NEW POSITION FOR FOCUS STATUS (Moved above the textarea) -->
                <div id="focus-status-display" class="p-2 mb-3 rounded-lg text-center font-bold text-sm bg-gray-700">
                    <!-- Content injected here by JS -->
                </div>

                <textarea id="journal-input" rows="5" placeholder="Write your reflective entry here..."
                    class="w-full p-3 mb-4 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-violet-500 focus:border-violet-500"></textarea>

                <button id="mine-button"
                    onclick="submitJournalEntry()"
                    class="w-full px-6 py-4 rounded-xl bg-violet-600 text-white text-xl font-bold button-primary disabled:opacity-50 disabled:cursor-not-allowed hover:bg-violet-700">
                    Submit Journal Entry
                </button>

                <p id="claim-message" class="text-xs text-center mt-3 h-4 text-red-400"></p>
            </div>

            <!-- 2. Entry Reward Upgrades and Ledger Button -->
            <div class="miner-card p-6 rounded-xl lg:col-span-1 flex flex-col">
                <h2 class="text-2xl font-semibold mb-4 text-white">Cultivate Awareness</h2>
                <p class="text-sm text-gray-400 mb-4">Invest $DNX$ to permanently improve your mining protocol.</p>

                <div id="upgrades" class="flex-grow space-y-3">
                    
                    <!-- Tiered Upgrade: Conscious Engagement Protocol (CEP) -->
                    <div id="upgrade-cep" class="bg-gray-800 p-3 rounded-lg border-l-4 border-violet-500">
                        <div>
                            <p id="cep-title" class="text-lg font-semibold">Conscious Engagement Protocol (CEP) - Tier 0</p>
                            <p id="cep-desc" class="text-xs text-gray-400">Unlock the first layer of enhanced rewards.</p>
                        </div>
                        <button id="cep-button" 
                            onclick="buyCepUpgrade()"
                            class="mt-3 w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold button-primary hover:bg-green-700">
                            Cost: 0.15 $DNX$ (+0.01 $DNX$)
                        </button>
                    </div>

                    <!-- Utility Upgrade: Systemic Clarity Upgrade -->
                    <div id="upgrade-clarity" class="flex justify-between items-center bg-gray-800 p-3 rounded-lg">
                        <div>
                            <p class="text-lg font-semibold">Systemic Clarity Upgrade</p>
                            <p class="text-xs text-gray-400">
                                Reduces min required characters from 50 to 30.
                            </p>
                        </div>
                        <button id="clarity-button" onclick="buyUtilityUpgrade(2.00, 'clarityPurchased')"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold button-primary hover:bg-green-700">
                            Cost: 2.0 $DNX$
                        </button>
                    </div>

                </div>

                <!-- Private Ledger Button -->
                <div class="mt-6 border-t border-gray-700 pt-4">
                    <button id="ledger-button"
                        onclick="openLedgerModal()"
                        class="w-full px-6 py-3 rounded-xl bg-gray-700 text-white font-bold button-primary hover:bg-gray-600">
                        View Private Ledger (Growth Tracker)
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Private Ledger Modal -->
    <div id="ledger-modal" class="modal fixed inset-0 hidden items-center justify-center p-4" onclick="closeLedgerModal(event)">
        <div class="modal-content w-full max-w-2xl rounded-xl p-6 overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                <h2 class="text-2xl font-bold text-white">Private Reflection Ledger</h2>
                <button onclick="closeLedgerModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            
            <p id="ledger-loading" class="text-center text-violet-400 py-8">Loading your past entries...</p>
            <div id="ledger-entries-list" class="space-y-4">
                <!-- Journal entries will be inserted here -->
            </div>
            <p id="ledger-empty" class="text-center text-gray-500 py-8 hidden">Your Ledger is empty. Submit your first journal entry!</p>
        </div>
    </div>

    <!-- Task Confirmation Modal (New) -->
    <div id="task-modal" class="modal fixed inset-0 hidden items-center justify-center p-4" onclick="closeTaskModal(event)">
        <div class="modal-content w-full max-w-lg rounded-xl p-6 overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                <h2 id="task-modal-title" class="text-2xl font-bold text-white"></h2>
                <button onclick="closeTaskModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            
            <div id="task-modal-content" class="text-gray-300 space-y-4">
                <!-- Content will be injected here -->
            </div>

            <div class="mt-6 flex justify-end">
                <button id="task-confirm-button"
                    class="px-6 py-3 rounded-xl bg-violet-600 text-white font-bold button-primary hover:bg-violet-700 mr-3">
                    Accept Commitment
                </button>
                <button onclick="closeTaskModal()"
                    class="px-6 py-3 rounded-xl bg-gray-700 text-white font-bold button-primary hover:bg-gray-600">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Global Game State (will be overridden by Firestore when ready)
        window.dnxBalance = 0.0;
        window.tapReward = 0.05; // Initial base reward per entry
        window.lastTapTimestamp = 0; 
        window.taskCompleted = { 1: false, 2: false };
        // UPDATED: Upgrades now tracked as a tiered integer and a separate utility flag
        window.upgrades = { 
            cepTier: 0, 
            clarityPurchased: false 
        }; 
        window.initialPromptIndex = 0; // Index of the prompt loaded at the start of the cycle
        window.currentPrompt = ""; // Stores the prompt text currently displayed
        window.isPromptRefreshed = false; // Tracks if the user hit the refresh button

        // Constants
        const MINT_COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        const BASE_MIN_CHARACTERS = 50;
        const CLARITY_MIN_CHARACTERS = 30;
        const FOCUS_MULTIPLIER = 1.2;
        const BASE_REWARD = 0.05;

        // --- NEW TIERED UPGRADE CONFIGURATION ---
        const CEP_UPGRADES = [
            // Tier 0 (Initial state) - Placeholder
            { name: "Initial Protocol", cost: 0, rewardIncrease: 0, description: "Base mining rate." },
            // Tier 1
            { name: "Focus Module (Tier 1)", cost: 0.15, rewardIncrease: 0.010, description: "Unlocks the **1.2x Focus Bonus** (if prompt is not refreshed)." },
            // Tier 2 (Approx 3x previous cost)
            { name: "Expansion Matrix (Tier 2)", cost: 0.50, rewardIncrease: 0.030, description: "Permanently boosts your base reward." },
            // Tier 3 (Approx 3x previous cost)
            { name: "Mastery Core (Tier 3)", cost: 1.50, rewardIncrease: 0.060, description: "Achieve maximum efficiency for $DNX$ mining." }
        ];

        // --- Refreshable Prompts List ---
        const JOURNAL_PROMPTS = [
            "Identify a 'shadow' or disowned part of yourself that was triggered today. What message was it trying to deliver? (Mirror Protocol)",
            "If you were the future version of yourself, what small, high-leverage action would you advise your current self to take right now? (Fractal Kernel)",
            "Where did you feel a sense of genuine connection or depth today, and what made that interaction different? (L$D Framework)",
            "Describe one moment where you successfully operated from your 'Observer Node' (awareness without judgment). What did you notice?",
            "What current life challenge can you re-frame as a necessary chapter in your 'Heroâ€™s Journey'? (Mythmaker Engine)"
        ];

        let uiUpdateInterval;
        const saveInterval = 30000; // Save every 30 seconds

        // --- Core Game Logic ---

        // Function to set the initial prompt based on the stored index
        window.displayInitialPrompt = function(isDefault) {
             const promptElement = document.getElementById('current-journal-prompt');
             if (promptElement) {
                // If using default, choose a random one. Otherwise, use the loaded index.
                let index = isDefault ? Math.floor(Math.random() * JOURNAL_PROMPTS.length) : window.initialPromptIndex;
                
                // Ensure index is valid
                if (index < 0 || index >= JOURNAL_PROMPTS.length) {
                    index = 0;
                }
                
                window.currentPrompt = JOURNAL_PROMPTS[index];
                promptElement.textContent = window.currentPrompt;
                window.isPromptRefreshed = false; // Reset refresh status for a new 24h cycle/load
            }
        }

        // Function to select and display a random prompt (used when refresh button is clicked)
        window.displayRandomPrompt = function(isRefreshClick = false) {
            const promptElement = document.getElementById('current-journal-prompt');
            if (promptElement) {
                const randomIndex = Math.floor(Math.random() * JOURNAL_PROMPTS.length);
                window.currentPrompt = JOURNAL_PROMPTS[randomIndex];
                promptElement.textContent = window.currentPrompt;
                
                if (isRefreshClick) {
                    window.isPromptRefreshed = true; // Mark as refreshed
                    updateUI(); // Immediately update focus status
                }
            }
        }

        function formatTimeRemaining(ms) {
            if (ms <= 0) return "0h 0m 0s";
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            return `${hours}h ${minutes}m ${seconds}s`;
        }
        
        // Calculates the current base tap reward based on upgrades
        function calculateCurrentBaseReward() {
            let totalIncrease = 0;
            for (let i = 1; i <= window.upgrades.cepTier; i++) {
                // Sums up all the reward increases from unlocked tiers
                totalIncrease += CEP_UPGRADES[i].rewardIncrease;
            }
            return BASE_REWARD + totalIncrease;
        }

        function updateUI() {
            // Update Base Reward before display
            window.tapReward = calculateCurrentBaseReward();

            document.getElementById('dnx-balance').textContent = window.dnxBalance.toFixed(4);
            document.getElementById('tap-reward').textContent = window.tapReward.toFixed(4);
            
            const mineButton = document.getElementById('mine-button');
            const miningStatus = document.getElementById('mining-status');
            const mintRemainingDisplay = document.getElementById('mint-remaining');
            const now = Date.now();
            
            const timeSinceLastMint = now - window.lastTapTimestamp;
            const timeRemaining = Math.max(0, MINT_COOLDOWN_MS - timeSinceLastMint);
            
            const isMintReady = timeRemaining === 0;

            // Determine required minimum characters based on Clarity Upgrade
            const minChars = window.upgrades.clarityPurchased ? CLARITY_MIN_CHARACTERS : BASE_MIN_CHARACTERS;
            document.getElementById('min-chars').textContent = `${minChars} characters`;
            
            // --- FOCUS STATUS DISPLAY LOGIC (NEW POSITION) ---
            const isFocusEligible = window.upgrades.cepTier >= 1 && !window.isPromptRefreshed;
            const focusDisplayElement = document.getElementById('focus-status-display');

            if (window.upgrades.cepTier >= 1) {
                 if (window.isPromptRefreshed) {
                    focusDisplayElement.innerHTML = "ðŸš« **Focus Bonus Disabled**: You refreshed the prompt. Mint will proceed at base rate.";
                    focusDisplayElement.classList.remove('bg-green-700', 'text-green-200', 'bg-violet-800', 'text-violet-200');
                    focusDisplayElement.classList.add('bg-yellow-800', 'text-yellow-200');
                } else {
                    focusDisplayElement.innerHTML = "ðŸŽ¯ **FOCUS BONUS ACTIVE**: Submit entry now for **1.2x $DNX$** reward!";
                    focusDisplayElement.classList.remove('bg-yellow-800', 'text-yellow-200', 'bg-violet-800', 'text-violet-200');
                    focusDisplayElement.classList.add('bg-green-700', 'text-green-200');
                }
            } else {
                 focusDisplayElement.innerHTML = "ðŸ’¡ **TIP**: Purchase **Focus Module (Tier 1)** to unlock the **1.2x Focus Bonus**!";
                 focusDisplayElement.classList.remove('bg-green-700', 'text-green-200', 'bg-yellow-800', 'text-yellow-200');
                 focusDisplayElement.classList.add('bg-violet-800', 'text-violet-200');
            }


            if (isMintReady) {
                // Calculate potential reward including focus multiplier
                let totalReward = window.tapReward;
                let bonusText = "";

                if (isFocusEligible) {
                    totalReward *= FOCUS_MULTIPLIER;
                    bonusText = `(x${FOCUS_MULTIPLIER.toFixed(1)} Focus)`;
                }
                
                miningStatus.textContent = "MINT READY: Next entry will earn $DNX$";
                miningStatus.style.backgroundColor = 'var(--mint-ready)';
                miningStatus.style.color = '#000';
                mintRemainingDisplay.textContent = "NOW!";
                mintRemainingDisplay.style.color = 'var(--mint-ready)';
                mineButton.textContent = `Submit Journal Entry & MINT ${totalReward.toFixed(4)} $DNX$ ${bonusText}`;
            } else {
                miningStatus.textContent = "Minting is on Cooldown. Entry will only be saved.";
                miningStatus.style.backgroundColor = '#4b5563'; 
                miningStatus.style.color = '#e5e7eb';
                mintRemainingDisplay.textContent = formatTimeRemaining(timeRemaining);
                mintRemainingDisplay.style.color = '#fcd34d'; 
                mineButton.textContent = "Submit Journal Entry (No Mint)";
            }

            mineButton.disabled = false;
            mineButton.classList.remove('button-disabled');

            // --- Update UPGRADE UI ---
            const nextTier = window.upgrades.cepTier + 1;
            const cepDiv = document.getElementById('upgrade-cep');
            const cepTitle = document.getElementById('cep-title');
            const cepDesc = document.getElementById('cep-desc');
            const cepButton = document.getElementById('cep-button');

            if (nextTier <= 3) {
                const upgrade = CEP_UPGRADES[nextTier];
                const currentReward = calculateCurrentBaseReward();
                const newReward = currentReward + upgrade.rewardIncrease;
                
                cepTitle.textContent = `${upgrade.name}`;
                cepDesc.innerHTML = `${upgrade.description} Current Base: ${currentReward.toFixed(4)} $DNX$ &rarr; **New Base: ${newReward.toFixed(4)} $DNX$**.`;
                cepButton.textContent = `Cost: ${upgrade.cost.toFixed(2)} $DNX$`;
                cepDiv.classList.remove('upgrade-purchased');
                cepButton.disabled = false;

                if (window.dnxBalance < upgrade.cost) {
                    cepButton.disabled = true;
                    cepButton.classList.add('button-disabled');
                } else {
                    cepButton.classList.remove('button-disabled');
                }

            } else {
                cepTitle.textContent = `Conscious Engagement Protocol - MAXED`;
                cepDesc.textContent = `All three tiers activated. Max base reward reached.`;
                cepButton.textContent = `Purchased`;
                cepButton.disabled = true;
                cepDiv.classList.add('upgrade-purchased');
            }


            // Update Utility Upgrade UI
            const clarityButton = document.getElementById('clarity-button');
            const clarityDiv = document.getElementById('upgrade-clarity');

            if (window.upgrades.clarityPurchased) {
                clarityButton.textContent = 'Purchased';
                clarityButton.disabled = true;
                clarityDiv.classList.add('upgrade-purchased');
            } else {
                clarityDiv.classList.remove('upgrade-purchased');
                clarityButton.disabled = window.dnxBalance < 2.00;
                clarityButton.classList.toggle('button-disabled', window.dnxBalance < 2.00);
            }
            

            // Update tasks UI
            document.getElementById('task-1').disabled = window.taskCompleted[1];
            document.getElementById('task-2').disabled = window.taskCompleted[2];
            document.getElementById('task-1').classList.toggle('button-disabled', window.taskCompleted[1]);
            document.getElementById('task-2').classList.toggle('button-disabled', window.taskCompleted[2]);
        }

        function startUIUpdateLoop() {
            if (uiUpdateInterval) clearInterval(uiUpdateInterval);
            // Run every second to update the countdown timer
            uiUpdateInterval = setInterval(updateUI, 1000); 
        }


        // Primary Journal Submission function (conditional minting)
        window.submitJournalEntry = async function() {
            const now = Date.now();
            const journalInput = document.getElementById('journal-input');
            const journalText = journalInput.value.trim();
            const mineButton = document.getElementById('mine-button');
            
            const timeSinceLastMint = now - window.lastTapTimestamp;
            const isMintReady = timeSinceLastMint >= MINT_COOLDOWN_MS;
            let didMint = false;
            let reward = 0.0;
            
            // Determine required minimum characters based on Clarity Upgrade
            const minChars = window.upgrades.clarityPurchased ? CLARITY_MIN_CHARACTERS : BASE_MIN_CHARACTERS;

            if (journalText.length < minChars) {
                document.getElementById('claim-message').textContent = `Entry is too short (${journalText.length} chars). Minimum ${minChars} characters required for reflection.`;
                setTimeout(() => document.getElementById('claim-message').textContent = '', 3000);
                return;
            }

            // Temporarily disable the button during submission
            mineButton.disabled = true;
            const originalText = mineButton.textContent;
            mineButton.textContent = 'Securing Insight...';
            document.getElementById('mining-status').textContent = "Processing and Securing Entry...";

            await new Promise(resolve => setTimeout(resolve, 1500)); 

            if (isMintReady) {
                // Reward is based on the current calculated base tapReward
                reward = window.tapReward;
                
                // Apply Micro-Focus Multiplier if applicable (only if Tier 1 or higher)
                const isFocusEligible = window.upgrades.cepTier >= 1 && !window.isPromptRefreshed;
                if (isFocusEligible) {
                    reward *= FOCUS_MULTIPLIER;
                }
                
                window.dnxBalance += reward;
                window.lastTapTimestamp = now; // Reset the 24-hour clock
                didMint = true;
                
                // Reset the prompt state for the new cycle
                window.isPromptRefreshed = false;
                window.initialPromptIndex = Math.floor(Math.random() * JOURNAL_PROMPTS.length); // Pick new initial prompt
                displayInitialPrompt(false); 
            }
            
            // Save the journal entry
            await saveJournalEntry(journalText, didMint, reward, window.currentPrompt); 

            // Clear the input and restore the button
            journalInput.value = '';
            mineButton.textContent = originalText;
            mineButton.disabled = false;

            if (didMint) {
                document.getElementById('claim-message').textContent = `SUCCESS: Entry MINTED ${reward.toFixed(4)} $DNX$! Next mint is available in 24 hours.`;
            } else {
                document.getElementById('claim-message').textContent = `Journal entry secured. Minting paused. Continue reflecting!`;
            }
            setTimeout(() => document.getElementById('claim-message').textContent = '', 4000);

            saveGameState(); // Save the new state
            updateUI();
        }

        // Handles the purchase of the tiered CEP upgrade
        window.buyCepUpgrade = function() {
            const nextTier = window.upgrades.cepTier + 1;
            if (nextTier > 3) {
                document.getElementById('claim-message').textContent = "CEP is already at max tier!";
                setTimeout(() => document.getElementById('claim-message').textContent = '', 2000);
                return;
            }

            const upgrade = CEP_UPGRADES[nextTier];
            
            if (window.dnxBalance >= upgrade.cost) {
                window.dnxBalance -= upgrade.cost;
                window.upgrades.cepTier = nextTier; // Increment the tier

                // Recalculate and update the reward now
                window.tapReward = calculateCurrentBaseReward();

                document.getElementById('claim-message').textContent = `${upgrade.name} activated! New base reward is ${window.tapReward.toFixed(4)} $DNX$.`;
                setTimeout(() => document.getElementById('claim-message').textContent = '', 4000);
                
                updateUI();
                saveGameState();
            } else {
                document.getElementById('claim-message').textContent = `Insufficient $DNX$. Need ${upgrade.cost.toFixed(2)} $DNX$ to unlock the next tier.`;
                setTimeout(() => document.getElementById('claim-message').textContent = '', 2000);
            }
        }
        
        // Handles the purchase of the utility (non-tiered) Clarity upgrade
        window.buyUtilityUpgrade = function(cost, upgradeKey) {
            if (window.upgrades[upgradeKey]) {
                document.getElementById('claim-message').textContent = "Upgrade already purchased!";
                setTimeout(() => document.getElementById('claim-message').textContent = '', 2000);
                return;
            }

            if (window.dnxBalance >= cost) {
                window.dnxBalance -= cost;
                window.upgrades[upgradeKey] = true; // Mark as purchased

                document.getElementById('claim-message').textContent = `Systemic Clarity activated! Min entry length reduced to ${CLARITY_MIN_CHARACTERS}.`;
                setTimeout(() => document.getElementById('claim-message').textContent = '', 4000);
                
                updateUI();
                saveGameState();
            } else {
                document.getElementById('claim-message').textContent = `Insufficient $DNX$ balance! Need ${cost.toFixed(2)} $DNX$.`;
                setTimeout(() => document.getElementById('claim-message').textContent = '', 2000);
            }
        }
        
        // Simulates completing a one-time referral/sign-up task
        window.completeTask = function(reward, taskId) {
            if (window.taskCompleted[taskId]) return;

            window.dnxBalance += reward;
            window.taskCompleted[taskId] = true;
            
            document.getElementById('claim-message').textContent = `Task ${taskId} completed! Deepened the Nexus, earned ${reward.toFixed(1)} $DNX$.`;
            setTimeout(() => document.getElementById('claim-message').textContent = '', 3000);
            
            updateUI();
            saveGameState();
        }

        // --- Modal Logic (Unchanged from previous version) ---

        const TASK_CONTENT = {
            1: {
                title: "Initiate: The Depth Operating System",
                reward: 0.1,
                confirmText: 'Accept OS & Earn',
                html: `
                    <p class="text-xl font-semibold text-violet-300 mb-4">
                        You donâ€™t download this OS; you choose it daily.
                    </p>
                    <p class="mb-2">Begin by asking yourself, in this moment:</p>
                    <ul class="list-disc list-inside space-y-2 ml-4">
                        <li>
                            <span class="font-medium text-white">Do I accept that I can change how I see my life?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                        <li>
                            <span class="font-medium text-white">Am I willing to gently question my own thoughts?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                        <li>
                            <span class="font-medium text-white">Will I prioritize genuine connection over superficial scrolling?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                    </ul>
                    <p class="mt-4 text-sm text-gray-400 border-t border-gray-700 pt-3">
                        If you answered yes to even oneâ€”congratulations. Youâ€™re already running the new OS. Click the button below to cement this commitment and claim your $DNX$.
                    </p>
                `
            },
            2: {
                title: "Verify: The Digital Integrity Protocol",
                reward: 0.2,
                confirmText: 'Accept Integrity & Earn',
                html: `
                    <p class="text-xl font-semibold text-violet-300 mb-4">
                        Verification is Integrity. Close the Gap between Public and Private Self.
                    </p>
                    <p class="mb-2">To verify your Digital Identity (Integrity Protocol), answer these:</p>
                    <ul class="list-disc list-inside space-y-2 ml-4">
                        <li>
                            <span class="font-medium text-white">Am I willing to integrate my "shadow"â€”the parts of myself I reject or hide (Mirror Protocol)?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                        <li>
                            <span class="font-medium text-white">Do I actively choose my life's narrative (Mythmaker), or default to a passive script?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                        <li>
                            <span class="font-medium text-white">Will I allow my choices to be guided by my highest values, not just immediate comfort (L$D Framework)?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                    </ul>
                    <p class="mt-4 text-sm text-gray-400 border-t border-gray-700 pt-3">
                        Answering yes verifies your commitment to wholeness. Click the button below to lock in this deeper commitment and claim your $DNX$.
                    </p>
                `
            }
        };


        window.openTaskModal = function(taskId) {
            const modal = document.getElementById('task-modal');
            const title = document.getElementById('task-modal-title');
            const content = document.getElementById('task-modal-content');
            const confirmButton = document.getElementById('task-confirm-button');
            const taskData = TASK_CONTENT[taskId];

            if (!taskData || window.taskCompleted[taskId]) return;
            
            title.textContent = taskData.title;
            content.innerHTML = taskData.html;
            
            confirmButton.textContent = `${taskData.confirmText} ${taskData.reward.toFixed(1)} $DNX$`;
            confirmButton.onclick = () => {
                completeTask(taskData.reward, taskId);
                closeTaskModal();
            };

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeTaskModal = function(event) {
            if (!event || event.currentTarget.id === 'task-modal') {
                document.getElementById('task-modal').classList.add('hidden');
                document.getElementById('task-modal').classList.remove('flex');
            }
        }

        window.openLedgerModal = async function() {
            const modal = document.getElementById('ledger-modal');
            const loading = document.getElementById('ledger-loading');
            const empty = document.getElementById('ledger-empty');
            const listContainer = document.getElementById('ledger-entries-list');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            loading.classList.remove('hidden');
            empty.classList.add('hidden');
            listContainer.innerHTML = ''; 

            if (!window.isAuthReady || !window.db || !window.userId) {
                loading.textContent = 'Connection not ready. Please wait a moment for the user session to initialize.';
                return;
            }
            
            loading.textContent = 'Loading your past entries...';

            const entries = await fetchJournalEntries();

            loading.classList.add('hidden');
            
            if (entries.length === 0) {
                empty.classList.remove('hidden');
                return;
            }

            entries.forEach(entry => {
                const date = new Date(entry.timestamp).toLocaleString();
                const SNIPPET_LENGTH = 300;
                const textSnippet = entry.text.substring(0, SNIPPET_LENGTH) + (entry.text.length > SNIPPET_LENGTH ? '...' : '');
                
                let mintStatus;
                if (entry.wasMinted) {
                    mintStatus = `<span class="text-green-400 font-semibold">Minted ${entry.dnxReward.toFixed(4)} $DNX$</span>`;
                } else {
                    mintStatus = `<span class="text-yellow-400 font-semibold">Saved (No Mint)</span>`;
                }

                const promptUsed = entry.prompt ? `<p class="text-xs text-gray-500 mt-1">Prompt: "${entry.prompt}"</p>` : '';

                const entryHtml = `
                    <div class="bg-gray-800 p-4 rounded-lg border-l-4 ${entry.wasMinted ? 'border-green-500' : 'border-yellow-500'}">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-sm text-gray-400">${date}</p>
                            ${mintStatus}
                        </div>
                        <p class="text-white text-md italic whitespace-pre-wrap">${textSnippet}</p>
                        ${promptUsed}
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', entryHtml);
            });
        }

        window.closeLedgerModal = function(event) {
            if (!event || event.currentTarget.id === 'ledger-modal') {
                document.getElementById('ledger-modal').classList.add('hidden');
                document.getElementById('ledger-modal').classList.remove('flex');
            }
        }


        // --- Initialization ---

        window.onload = function() {
            setupFirebase();
            startUIUpdateLoop();
            setInterval(saveGameState, saveInterval);
        };

    </script>
</body>
</html>
