<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depth Nexus - Journal Miner & Conscious Engagement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Using a deep, purposeful blue/purple to signify 'Depth' */
            --depth-color: #7c3aed; /* violet-600 */
            --mint-ready: #10b981; /* emerald-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0c0c1e; /* Deep dark blue */
            color: #e5e7eb;
        }
        .miner-card {
            background-color: #1a1b32; /* Slightly lighter deep blue */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            border-top: 4px solid var(--depth-color);
        }
        .button-primary {
            transition: all 0.15s ease;
        }
        .button-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }
        .button-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .cooldown-text {
            min-height: 20px; /* Ensure space is reserved */
            font-size: 0.875rem;
            font-weight: 600;
        }
        /* Modal Styles */
        .modal {
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 50;
        }
        .modal-content {
            max-height: 90vh; /* Limit modal height */
            background-color: #1a1b32;
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NOTE: Added query, orderBy, getDocs for fetching the journal history
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances and state
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;

        // Ensure global access to game functions
        window.saveGameState = saveGameState;
        window.loadGameState = loadGameState;
        window.setupFirebase = setupFirebase;
        window.submitJournalEntry = submitJournalEntry;
        window.buyUpgrade = buyUpgrade;
        window.completeTask = completeTask;
        window.openLedgerModal = openLedgerModal; 
        window.closeLedgerModal = closeLedgerModal; 
        window.openTaskModal = openTaskModal; 
        window.closeTaskModal = closeTaskModal; 
        window.displayRandomPrompt = displayRandomPrompt; // Exposed for button click

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('Debug');

        async function setupFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase configuration is missing.");
                window.isAuthReady = true;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                window.db = getFirestore(app);
                window.auth = getAuth(app);

                // Initial sign-in attempt
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        console.log("Authenticated with user ID:", window.userId);
                    } else {
                        // Should already be signed in anonymously if token failed
                        window.userId = null;
                    }
                    window.isAuthReady = true;
                    // Only start loading game state once auth is confirmed
                    loadGameState(); 
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                window.isAuthReady = true;
                loadGameState();
            }
        }

        function getMinerDocRef() {
            if (!window.db || !window.userId) return null;
            // Private data storage path for miner state
            const path = `artifacts/${appId}/users/${window.userId}/depth_nexus_data`;
            return doc(window.db, path, 'miner_state');
        }

        function getJournalCollectionRef() {
            if (!window.db || !window.userId) return null;
            // Private data storage path for journal entries
            const path = `artifacts/${appId}/users/${window.userId}/journal_entries`;
            return collection(window.db, path);
        }

        async function saveGameState() {
            if (!window.isAuthReady || !window.db || !window.userId) return;

            const state = {
                dnxBalance: window.dnxBalance,
                tapReward: window.tapReward,
                lastTapTimestamp: window.lastTapTimestamp,
                taskCompleted: window.taskCompleted,
                lastSave: Date.now(),
            };
            try {
                await setDoc(getMinerDocRef(), state, { merge: true });
                console.log("Miner state saved.");
            } catch (e) {
                console.error("Error saving miner state: ", e);
            }
        }

        async function saveJournalEntry(text, wasMinted, reward, promptText) {
            const collectionRef = getJournalCollectionRef();
            if (!collectionRef) {
                console.error("Cannot save journal: Firebase not ready.");
                return;
            }
            try {
                await addDoc(collectionRef, {
                    timestamp: Date.now(),
                    text: text,
                    wasMinted: wasMinted,
                    dnxReward: reward,
                    prompt: promptText, // Save the prompt that was used
                    userId: window.userId
                });
                console.log("Journal entry saved to Firestore (Collection).");
            } catch (e) {
                console.error("Error saving journal entry: ", e);
            }
        }
        
        // New function to fetch journal entries for the ledger
        async function fetchJournalEntries() {
            const collectionRef = getJournalCollectionRef();
            if (!collectionRef) {
                // This indicates a missing database or user ID (auth issue)
                console.error("Journal collection not available. Auth or DB not ready.");
                return [];
            }

            try {
                // Query ordered by timestamp descending (newest first)
                const q = query(collectionRef, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                const entries = [];
                querySnapshot.forEach((doc) => {
                    entries.push({ id: doc.id, ...doc.data() });
                });
                
                console.log(`Fetched ${entries.length} journal entries for the ledger.`); // Log the count!
                return entries;

            } catch (e) {
                console.error("Error fetching journal entries:", e);
                return [];
            }
        }

        function loadGameState() {
            if (!window.isAuthReady || !window.db || !window.userId) {
                console.log("Using default in-memory state.");
                document.getElementById('user-id').textContent = 'Persistence Disabled';
                updateUI();
                return;
            }

            const docRef = getMinerDocRef();
            // Using onSnapshot to ensure real-time updates to balance
            onSnapshot(docRef, (docSnap) => { 
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    window.dnxBalance = data.dnxBalance || 0.0;
                    window.tapReward = data.tapReward || 0.05;
                    window.lastTapTimestamp = data.lastTapTimestamp || 0;
                    window.taskCompleted = data.taskCompleted || { 1: false, 2: false };
                    
                    console.log("Game state loaded successfully.");
                } else {
                    console.log("No data found, using defaults and saving initial state.");
                    saveGameState();
                }
                updateUI();
            }, (error) => {
                console.error("Error listening to document:", error);
                updateUI();
            });

            document.getElementById('user-id').textContent = window.userId;
        }

    </script>

</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="game-container" class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-white">
                <span style="color:var(--depth-color);">$DEPTH</span> Ecosystem: Depth Nexus
            </h1>
            <p class="text-sm mt-2 text-gray-400">
                Incentivizing Consciousness: **Journal to Mine** $DNX$ once every 24 hours.
            </p>
            <p id="user-info" class="text-sm mt-2 text-gray-600">
                User ID: <span id="user-id" class="text-xs text-gray-700">Loading...</span>
            </p>
        </header>

        <!-- Main Stats & Balance -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="miner-card p-4 rounded-xl">
                <p class="text-sm font-medium text-gray-400">Your $DNX$ Balance</p>
                <p id="dnx-balance" class="text-3xl font-bold text-white mt-1">0.0000</p>
            </div>
            <div class="miner-card p-4 rounded-xl">
                <p class="text-sm font-medium text-gray-400">Reward Per Mint</p>
                <p id="tap-reward" class="text-3xl font-bold text-white mt-1">0.0500</p>
            </div>
            <div class="miner-card p-4 rounded-xl">
                <p class="text-sm font-medium text-gray-400">Next $DNX$ Mint in</p>
                <p id="mint-remaining" class="text-xl sm:text-3xl font-bold text-green-400 mt-1">0h 0m 0s</p>
            </div>
        </div>

        <!-- Mining and Educational Claim Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- 1. Journal Entry Area -->
            <div class="miner-card p-6 rounded-xl lg:col-span-1">
                <h2 class="text-2xl font-semibold mb-4 text-white">Daily Conscious Journal</h2>
                <p class="text-sm text-gray-400 mb-4">Plant your daily seed of self-awareness. Submission requires a minimum of **50 characters**.</p>
                
                <div id="mining-status" class="cooldown-text text-center py-2 mb-4 text-yellow-300 rounded-lg">Checking Mint Eligibility...</div>
                
                <!-- Dynamic Journal Prompt and Refresh Button -->
                <div class="flex justify-between items-center mb-2">
                    <p class="text-white font-medium text-sm">Today's Prompt:</p>
                    <button onclick="displayRandomPrompt()" class="text-xs text-violet-400 hover:text-violet-300 font-bold border border-violet-400 px-2 py-1 rounded-full transition duration-150">
                        Refresh
                    </button>
                </div>
                <p id="current-journal-prompt" class="text-violet-400 italic mb-4 text-base">Loading prompt...</p>
                
                <textarea id="journal-input" rows="5" placeholder="Write your reflective entry here... (Min 50 characters)"
                    class="w-full p-3 mb-4 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-violet-500 focus:border-violet-500"></textarea>

                <button id="mine-button"
                    onclick="submitJournalEntry()"
                    class="w-full px-6 py-4 rounded-xl bg-violet-600 text-white text-xl font-bold button-primary disabled:opacity-50 disabled:cursor-not-allowed hover:bg-violet-700">
                    Submit Journal Entry
                </button>

                <p id="claim-message" class="text-xs text-center mt-3 h-4 text-red-400"></p>
            </div>

            <!-- 2. Entry Reward Upgrades and Ledger Button -->
            <div class="miner-card p-6 rounded-xl lg:col-span-1 flex flex-col">
                <h2 class="text-2xl font-semibold mb-4 text-white">Cultivate Awareness</h2>
                <p class="text-sm text-gray-400 mb-4">Invest $DNX$ to increase your reward per daily journal entry **when minting is available**.</p>

                <div id="upgrades" class="flex-grow">
                    <!-- Upgrade 1 -->
                    <div class="flex justify-between items-center bg-gray-800 p-3 rounded-lg mb-3">
                        <div>
                            <p class="text-lg font-semibold">Micro-Focus Module</p>
                            <p class="text-xs text-gray-400">Increase entry reward by +0.010 $DNX$</p>
                        </div>
                        <button onclick="buyUpgrade(0.5, 0.0100)"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold button-primary hover:bg-green-700">
                            Cost: 0.5 $DNX$
                        </button>
                    </div>

                    <!-- Upgrade 2 -->
                    <div class="flex justify-between items-center bg-gray-800 p-3 rounded-lg mb-3">
                        <div>
                            <p class="text-lg font-semibold">Systemic Clarity Upgrade</p>
                            <p class="text-xs text-gray-400">Increase entry reward by +0.050 $DNX$</p>
                        </div>
                        <button onclick="buyUpgrade(5.0, 0.0500)"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold button-primary hover:bg-green-700">
                            Cost: 5.0 $DNX$
                        </button>
                    </div>
                </div>

                <!-- Private Ledger Button -->
                <div class="mt-6 border-t border-gray-700 pt-4">
                    <button id="ledger-button"
                        onclick="openLedgerModal()"
                        class="w-full px-6 py-3 rounded-xl bg-gray-700 text-white font-bold button-primary hover:bg-gray-600">
                        View Private Ledger (Growth Tracker)
                    </button>
                </div>
            </div>
        </div>

        <!-- Ecosystem Synergy Tasks -->
        <div class="miner-card p-6 rounded-xl">
            <h2 class="text-2xl font-semibold mb-4 text-white">Ecosystem Synergy Tasks</h2>
            <p class="text-sm text-gray-400 mb-4">Complete one-time onboarding tasks for the main $DEPTH$ project to earn bonus $DNX$, cementing your connection to the core network.</p>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="task-list">
                <!-- Task 1: Wallet Sign-Up (Now Opens Modal) -->
                <div class="bg-gray-800 p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-white">Install $DEPTH$ Wallet</p>
                        <p class="text-xs text-gray-400">Secure your entry point to the conscious economy.</p>
                    </div>
                    <button id="task-1" onclick="openTaskModal(1)"
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold button-primary hover:bg-purple-700">
                        Earn 0.1 $DNX$
                    </button>
                </div>
                <!-- Task 2: KYC/Verification (Now Opens Modal) -->
                <div class="bg-gray-800 p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-white">Verify Digital Identity</p>
                        <p class="text-xs text-gray-400">Align your identity with the $DEPTH$ platform.</p>
                    </div>
                    <button id="task-2" onclick="openTaskModal(2)"
                        class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold button-primary hover:bg-purple-700">
                        Earn 0.2 $DNX$
                    </button>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Private Ledger Modal -->
    <div id="ledger-modal" class="modal fixed inset-0 hidden items-center justify-center p-4" onclick="closeLedgerModal(event)">
        <div class="modal-content w-full max-w-2xl rounded-xl p-6 overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                <h2 class="text-2xl font-bold text-white">Private Reflection Ledger</h2>
                <button onclick="closeLedgerModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            
            <p id="ledger-loading" class="text-center text-violet-400 py-8">Loading your past entries...</p>
            <div id="ledger-entries-list" class="space-y-4">
                <!-- Journal entries will be inserted here -->
            </div>
            <p id="ledger-empty" class="text-center text-gray-500 py-8 hidden">Your Ledger is empty. Submit your first journal entry!</p>
        </div>
    </div>

    <!-- Task Confirmation Modal (New) -->
    <div id="task-modal" class="modal fixed inset-0 hidden items-center justify-center p-4" onclick="closeTaskModal(event)">
        <div class="modal-content w-full max-w-lg rounded-xl p-6 overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                <h2 id="task-modal-title" class="text-2xl font-bold text-white"></h2>
                <button onclick="closeTaskModal()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            
            <div id="task-modal-content" class="text-gray-300 space-y-4">
                <!-- Content will be injected here -->
            </div>

            <div class="mt-6 flex justify-end">
                <button id="task-confirm-button"
                    class="px-6 py-3 rounded-xl bg-violet-600 text-white font-bold button-primary hover:bg-violet-700 mr-3">
                    Accept Commitment
                </button>
                <button onclick="closeTaskModal()"
                    class="px-6 py-3 rounded-xl bg-gray-700 text-white font-bold button-primary hover:bg-gray-600">
                    Cancel
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        // Global Game State (will be overridden by Firestore when ready)
        window.dnxBalance = 0.0;
        window.tapReward = 0.05; // Initial reward per entry
        window.lastTapTimestamp = 0; 
        window.taskCompleted = { 1: false, 2: false };
        window.currentPrompt = ""; // Stores the prompt text currently displayed

        // Constants
        const MINT_COOLDOWN_MS = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
        const MIN_CHARACTERS = 50;
        
        // --- NEW: Refreshable Prompts List ---
        const JOURNAL_PROMPTS = [
            "Identify a 'shadow' or disowned part of yourself that was triggered today. What message was it trying to deliver? (Mirror Protocol)",
            "If you were the future version of yourself, what small, high-leverage action would you advise your current self to take right now? (Fractal Kernel)",
            "Where did you feel a sense of genuine connection or depth today, and what made that interaction different? (L$D Framework)",
            "Describe one moment where you successfully operated from your 'Observer Node' (awareness without judgment). What did you notice?",
            "What current life challenge can you re-frame as a necessary chapter in your 'Hero’s Journey'? (Mythmaker Engine)"
        ];

        let uiUpdateInterval;
        const saveInterval = 30000; // Save every 30 seconds

        // --- Core Game Logic ---

        // Function to select and display a random prompt
        window.displayRandomPrompt = function() {
            const promptElement = document.getElementById('current-journal-prompt');
            if (promptElement) {
                const randomIndex = Math.floor(Math.random() * JOURNAL_PROMPTS.length);
                window.currentPrompt = JOURNAL_PROMPTS[randomIndex];
                promptElement.textContent = window.currentPrompt;
            }
        }

        function formatTimeRemaining(ms) {
            if (ms <= 0) return "0h 0m 0s";
            const hours = Math.floor(ms / (1000 * 60 * 60));
            const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((ms % (1000 * 60)) / 1000);
            return `${hours}h ${minutes}m ${seconds}s`;
        }

        function updateUI() {
            document.getElementById('dnx-balance').textContent = window.dnxBalance.toFixed(4);
            document.getElementById('tap-reward').textContent = window.tapReward.toFixed(4);
            
            const mineButton = document.getElementById('mine-button');
            const miningStatus = document.getElementById('mining-status');
            const mintRemainingDisplay = document.getElementById('mint-remaining');
            const now = Date.now();
            
            const timeSinceLastMint = now - window.lastTapTimestamp;
            const timeRemaining = Math.max(0, MINT_COOLDOWN_MS - timeSinceLastMint);
            
            const isMintReady = timeRemaining === 0;

            if (isMintReady) {
                miningStatus.textContent = "MINT READY: Next entry will earn $DNX$";
                miningStatus.style.backgroundColor = 'var(--mint-ready)';
                miningStatus.style.color = '#000';
                mintRemainingDisplay.textContent = "NOW!";
                mintRemainingDisplay.style.color = 'var(--mint-ready)';
                mineButton.textContent = `Submit Journal Entry & MINT ${window.tapReward.toFixed(4)} $DNX$`;
            } else {
                miningStatus.textContent = "Minting is on Cooldown. Entry will only be saved.";
                miningStatus.style.backgroundColor = '#4b5563'; /* Gray background for cooldown */
                miningStatus.style.color = '#e5e7eb';
                mintRemainingDisplay.textContent = formatTimeRemaining(timeRemaining);
                mintRemainingDisplay.style.color = '#fcd34d'; /* Amber for countdown */
                mineButton.textContent = "Submit Journal Entry (No Mint)";
            }

            mineButton.disabled = false;
            mineButton.classList.remove('button-disabled');

            // Update tasks UI
            document.getElementById('task-1').disabled = window.taskCompleted[1];
            document.getElementById('task-2').disabled = window.taskCompleted[2];
            document.getElementById('task-1').classList.toggle('button-disabled', window.taskCompleted[1]);
            document.getElementById('task-2').classList.toggle('button-disabled', window.taskCompleted[2]);
        }

        function startUIUpdateLoop() {
            if (uiUpdateInterval) clearInterval(uiUpdateInterval);
            // Run every second to update the countdown timer
            uiUpdateInterval = setInterval(updateUI, 1000); 
        }


        // Primary Journal Submission function (conditional minting)
        window.submitJournalEntry = async function() {
            const now = Date.now();
            const journalInput = document.getElementById('journal-input');
            const journalText = journalInput.value.trim();
            const mineButton = document.getElementById('mine-button');
            
            const timeSinceLastMint = now - window.lastTapTimestamp;
            const isMintReady = timeSinceLastMint >= MINT_COOLDOWN_MS;
            let didMint = false;
            let reward = 0.0;


            if (journalText.length < MIN_CHARACTERS) {
                document.getElementById('claim-message').textContent = `Entry is too short (${journalText.length} chars). Minimum ${MIN_CHARACTERS} characters required for reflection.`;
                setTimeout(() => document.getElementById('claim-message').textContent = '', 3000);
                return;
            }

            // Temporarily disable the button during submission
            mineButton.disabled = true;
            const originalText = mineButton.textContent;
            mineButton.textContent = 'Securing Insight...';
            document.getElementById('mining-status').textContent = "Processing and Securing Entry...";

            // Simulate the network and processing delay
            await new Promise(resolve => setTimeout(resolve, 2000)); 

            if (isMintReady) {
                // Perform the minting transaction
                reward = window.tapReward;
                window.dnxBalance += reward;
                window.lastTapTimestamp = now; // Reset the 24-hour clock
                didMint = true;
            }
            
            // Save the journal entry to the history collection (always happens)
            await saveJournalEntry(journalText, didMint, reward, window.currentPrompt); // Pass the current prompt

            // Clear the input and restore the button
            journalInput.value = '';
            mineButton.textContent = originalText;
            mineButton.disabled = false;

            if (didMint) {
                document.getElementById('claim-message').textContent = `SUCCESS: Entry MINTED ${reward.toFixed(4)} $DNX$! Next mint is available in 24 hours.`;
            } else {
                document.getElementById('claim-message').textContent = `Journal entry secured. Minting paused. Continue reflecting!`;
            }
            setTimeout(() => document.getElementById('claim-message').textContent = '', 4000);

            saveGameState(); // Save the new state
            updateUI();
            displayRandomPrompt(); // Get a new prompt immediately after submission
        }

        // Simulates buying upgrades
        window.buyUpgrade = function(cost, rewardIncrease) {
            if (window.dnxBalance >= cost) {
                window.dnxBalance -= cost;
                window.tapReward += rewardIncrease;
                document.getElementById('claim-message').textContent = `Awareness Cultivated! Reward is now ${window.tapReward.toFixed(4)} $DNX$ per mint.`;
                setTimeout(() => document.getElementById('claim-message').textContent = '', 3000);
                updateUI();
                saveGameState();
            } else {
                document.getElementById('claim-message').textContent = "Insufficient $DNX$ balance!";
                setTimeout(() => document.getElementById('claim-message').textContent = '', 2000);
            }
        }
        
        // Simulates completing a one-time referral/sign-up task
        window.completeTask = function(reward, taskId) {
            if (window.taskCompleted[taskId]) return;

            window.dnxBalance += reward;
            window.taskCompleted[taskId] = true;
            
            document.getElementById('claim-message').textContent = `Task ${taskId} completed! Deepened the Nexus, earned ${reward.toFixed(1)} $DNX$.`;
            setTimeout(() => document.getElementById('claim-message').textContent = '', 3000);
            
            updateUI();
            saveGameState();
        }

        // --- Task Modal Logic ---

        // Task content map for conceptual clarity
        const TASK_CONTENT = {
            1: {
                title: "Initiate: The Depth Operating System",
                reward: 0.1,
                confirmText: 'Accept OS & Earn',
                html: `
                    <p class="text-xl font-semibold text-violet-300 mb-4">
                        You don’t download this OS; you choose it daily.
                    </p>
                    <p class="mb-2">Begin by asking yourself, in this moment:</p>
                    <ul class="list-disc list-inside space-y-2 ml-4">
                        <li>
                            <span class="font-medium text-white">Do I accept that I can change how I see my life?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                        <li>
                            <span class="font-medium text-white">Am I willing to gently question my own thoughts?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                        <li>
                            <span class="font-medium text-white">Will I prioritize genuine connection over superficial scrolling?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                    </ul>
                    <p class="mt-4 text-sm text-gray-400 border-t border-gray-700 pt-3">
                        If you answered yes to even one—congratulations. You’re already running the new OS. Click the button below to cement this commitment and claim your $DNX$.
                    </p>
                `
            },
            2: {
                title: "Verify: The Digital Integrity Protocol",
                reward: 0.2,
                confirmText: 'Accept Integrity & Earn',
                html: `
                    <p class="text-xl font-semibold text-violet-300 mb-4">
                        Verification is Integrity. Close the Gap between Public and Private Self.
                    </p>
                    <p class="mb-2">To verify your Digital Identity (Integrity Protocol), answer these:</p>
                    <ul class="list-disc list-inside space-y-2 ml-4">
                        <li>
                            <span class="font-medium text-white">Am I willing to integrate my "shadow"—the parts of myself I reject or hide (Mirror Protocol)?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                        <li>
                            <span class="font-medium text-white">Do I actively choose my life's narrative (Mythmaker), or default to a passive script?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                        <li>
                            <span class="font-medium text-white">Will I allow my choices to be guided by my highest values, not just immediate comfort (L$D Framework)?</span> 
                            <span class="text-green-400 font-bold">[Y / N]</span>
                        </li>
                    </ul>
                    <p class="mt-4 text-sm text-gray-400 border-t border-gray-700 pt-3">
                        Answering yes verifies your commitment to wholeness. Click the button below to lock in this deeper commitment and claim your $DNX$.
                    </p>
                `
            }
        };


        window.openTaskModal = function(taskId) {
            const modal = document.getElementById('task-modal');
            const title = document.getElementById('task-modal-title');
            const content = document.getElementById('task-modal-content');
            const confirmButton = document.getElementById('task-confirm-button');
            const taskData = TASK_CONTENT[taskId];

            // Only open if task exists and hasn't been completed
            if (!taskData || window.taskCompleted[taskId]) return;
            
            // Set content
            title.textContent = taskData.title;
            content.innerHTML = taskData.html;
            
            // Update button text and set click handler dynamically
            confirmButton.textContent = `${taskData.confirmText} ${taskData.reward.toFixed(1)} $DNX$`;
            confirmButton.onclick = () => {
                // Run the task completion logic and then close
                completeTask(taskData.reward, taskId);
                closeTaskModal();
            };

            // Show the modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.closeTaskModal = function(event) {
            // Only close if clicked on the modal background itself, not content
            if (!event || event.currentTarget.id === 'task-modal') {
                document.getElementById('task-modal').classList.add('hidden');
                document.getElementById('task-modal').classList.remove('flex');
            }
        }

        // --- Ledger Modal Logic ---

        window.openLedgerModal = async function() {
            const modal = document.getElementById('ledger-modal');
            const loading = document.getElementById('ledger-loading');
            const empty = document.getElementById('ledger-empty');
            const listContainer = document.getElementById('ledger-entries-list');
            
            // 1. Show the modal and loading indicator
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            loading.classList.remove('hidden');
            empty.classList.add('hidden');
            listContainer.innerHTML = ''; // Clear previous entries

            // CRITICAL CHECK: Ensure Firebase is authenticated before attempting to fetch
            if (!window.isAuthReady || !window.db || !window.userId) {
                loading.textContent = 'Connection not ready. Please wait a moment for the user session to initialize.';
                return;
            }
            
            loading.textContent = 'Loading your past entries...';

            // 2. Fetch the data from Firestore
            const entries = await fetchJournalEntries();

            // 3. Hide loading
            loading.classList.add('hidden');
            
            if (entries.length === 0) {
                empty.classList.remove('hidden');
                return;
            }

            // 4. Iterate and Render: This loop creates the visible list items
            entries.forEach(entry => {
                // Prepare display data
                const date = new Date(entry.timestamp).toLocaleString();
                
                // Show a larger snippet (300 chars) for better context
                const SNIPPET_LENGTH = 300;
                const textSnippet = entry.text.substring(0, SNIPPET_LENGTH) + (entry.text.length > SNIPPET_LENGTH ? '...' : '');
                
                // Determine styling based on whether the entry earned DNX
                let mintStatus;
                if (entry.wasMinted) {
                    mintStatus = `<span class="text-green-400 font-semibold">Minted ${entry.dnxReward.toFixed(4)} $DNX$</span>`;
                } else {
                    mintStatus = `<span class="text-yellow-400 font-semibold">Saved (No Mint)</span>`;
                }

                // Get and display the prompt used
                const promptUsed = entry.prompt ? `<p class="text-xs text-gray-500 mt-1">Prompt: "${entry.prompt}"</p>` : '';

                // Construct the HTML structure for a single entry
                const entryHtml = `
                    <div class="bg-gray-800 p-4 rounded-lg border-l-4 ${entry.wasMinted ? 'border-green-500' : 'border-yellow-500'}">
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-sm text-gray-400">${date}</p>
                            ${mintStatus}
                        </div>
                        <p class="text-white text-md italic whitespace-pre-wrap">${textSnippet}</p>
                        ${promptUsed}
                    </div>
                `;
                // Insert the new entry HTML into the container
                listContainer.insertAdjacentHTML('beforeend', entryHtml);
            });
        }

        window.closeLedgerModal = function(event) {
            // Only close if clicked on the modal background itself, not content
            if (!event || event.currentTarget.id === 'ledger-modal') {
                document.getElementById('ledger-modal').classList.add('hidden');
                document.getElementById('ledger-modal').classList.remove('flex');
            }
        }


        // --- Initialization ---

        window.onload = function() {
            setupFirebase();
            startUIUpdateLoop();
            // Initialize the prompt on load
            displayRandomPrompt(); 
            // Setup regular save interval only after Firebase is initialized
            setInterval(saveGameState, saveInterval);
        };

    </script>
</body>
</html>
